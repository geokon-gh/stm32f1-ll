<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2019-03-02 六 11:18 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Low Level API - for STM32F1 chips</title>
<meta name="generator" content="Org mode">
<meta name="author" content="George Kontsevich">
<meta name="description" content="the LL API for the STM32F1. Extracted from the STM32 Cube HAL and wrapped in CMake for convenience"
>
<link rel="stylesheet" type="text/css" href="../static/worg.css" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2018 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href=".."> UP </a>
 |
 <a accesskey="H" href=".."> HOME </a>
</div><div id="content">
<h1 class="title">Low Level API - for STM32F1 chips</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgb78fe38">Intro</a></li>
<li><a href="#org89dd8fb">Removing the HAL</a></li>
<li><a href="#orga93b041">Adding the CMSIS</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgb78fe38" class="outline-2">
<h2 id="orgb78fe38">Intro</h2>
<div class="outline-text-2" id="text-orgb78fe38">
<p>
The STM32 Low Level API is an API provided as a part of the STM32 Cube HAL. It's inconvenient to get from the STM32 website, so I'm providing an easy to access copy here that is built without the HAL using CMake. Below I describe how I created this.
</p>
</div>
</div>

<div id="outline-container-org89dd8fb" class="outline-2">
<h2 id="org89dd8fb">Removing the HAL</h2>
<div class="outline-text-2" id="text-org89dd8fb">
<p>
<b>Note:</b> The STM32 Cube HAL is under a BSD license (per the documentation)
</p>

<p>
To start I took the HAL as provided by STM on <a href="https://www.st.com/content/st_com/en/products/embedded-software/mcus-embedded-software/stm32-embedded-software/stm32cube-mcu-packages/stm32cubef1.html">their website</a>. Then I copied all the <code>stm32f1xx_ll_*.c</code> files from <code>STM32Cube_FW_F1_V1.6.0/Drivers/STM32F1xx_HAL_Driver/Src</code> over to the <code>src</code> folder and added them to library
</p>

<div class="org-src-container">
<pre class="src src-cmake">cmake_minimum_required(VERSION 3.0)

add_library(ll
  src/stm32f1xx_ll_utils.c
  src/stm32f1xx_ll_usb.c
  src/stm32f1xx_ll_usart.c
  src/stm32f1xx_ll_tim.c
  src/stm32f1xx_ll_spi.c
  src/stm32f1xx_ll_sdmmc.c
  src/stm32f1xx_ll_rtc.c
  src/stm32f1xx_ll_rcc.c
  src/stm32f1xx_ll_pwr.c
  src/stm32f1xx_ll_i2c.c
  src/stm32f1xx_ll_gpio.c
  src/stm32f1xx_ll_fsmc.c
  src/stm32f1xx_ll_exti.c
  src/stm32f1xx_ll_dma.c
  src/stm32f1xx_ll_dac.c
  src/stm32f1xx_ll_crc.c
  src/stm32f1xx_ll_adc.c)
</pre>
</div>

<p>
Next I copied over their equivalent headers from <code>STM32Cube_FW_F1_V1.6.0/Drivers/STM32F1xx_HAL_Driver/Inc</code> over to the <code>inc</code> folder. B/c of how the Low Level API is configured I needed to also copy 3 extra files: 
</p>

<ul class="org-ul">
<li><code>stm32f1xx_hal.h</code></li>
<li><code>stm32f1xx_hal_def.h</code></li>
<li><code>stm32f1xx_hal_conf_template.h</code> which was copied over as <code>stm32f1xx_hal_conf.h</code></li>
</ul>

<p>
In this new <code>stm32f1xx_hal_conf.h</code> I then went to the <b>Module Selection</b> section at the top and comment out all the HAL modules starting from <code>#define HAL_MODULE_ENABLED</code> to completely disable the <code>HAL</code>. Next, per <a href="https://www.purplealienplanet.com/node/69">these instruction</a> I add a <code>#include "stm32f1xx_hal_def.h</code> somewhere a the top in this same file
</p>

<p>
Once that's all done I could add these LL-API headers
</p>

<div class="org-src-container">
<pre class="src src-cmake">target_include_directories(ll PUBLIC inc)
</pre>
</div>
</div>
</div>

<div id="outline-container-orga93b041" class="outline-2">
<h2 id="orga93b041">Adding the CMSIS</h2>
<div class="outline-text-2" id="text-orga93b041">
<p>
The CMSIS (Cortex Microcontroller Software Interface Standard) is the standard interface API for all ARM chips. It's common across all ARM vendors and STM's LL is build on top of this common layer. The CMSIS is also provided to us with the <b>STM Cube HAL</b> we downloaded - under <code>STM32Cube_FW_F1_V1.6.0/Drivers/CMSIS</code>. I copied this one over in its entirety. 
</p>

<p>
<b>Note:</b> The CMSIS is under the Apache 2.0 license
</p>

<p>
Naturally ARM boards are all quite different internally, including all the boards in the STM32 family. They will have different amount of space, different peripherals available and different memory layouts. So to have a common API and to enable the programmer to program once and run on all ARM chips you also need certain parts tailored to the particular chip. These configurations for the F1 family of chips are all located in <code>CMSIS/Device/ST/STM32F1xx/Include/</code> and as you can see - even withing one chip-type each chip has it's own configration file. These files will assign generic ARM variables like GPIOA<sub>BASE</sub> to actual memory location for <i>this particular chip</i>. So once we use the CMSIS we can program directly with these labels, like GPIO<sub>BASE</sub>, and under the hood - as long as you point at the right configuration file - everything works identically on different hardware.
</p>

<p>
Now the STM guys lein on this CMSIS mechanism to write their whole LL-API. You maybe noticed that we didn't do any chip configuration/selection in the previous section - it was all just one library for the whole F1 group of chips. If you open up the LL headers you will see that they all include a certain file <code>stm32f1xx.h</code> - and this is in a sense the entry point to the CMSIS for the LL-API. This include acts as a sort of "switch" which engages the correct configuration file for our particular chip for the CMSIS. The actual file is at <code>CMSIS/Device/ST/STM32F1xx/Include/stm32f1xx.h</code>. It's really short - so just open it up and at the top you will see a big ugly table where you can find the preprocessor switch values that you will use. Once we set this value the correct configuration file gets included and everything simply works across the whole LL
</p>

<p>
B/c the <b>bluepill</b> uses a <code>STM32F103C8T6</code>, this maps to a proprocessor value of <code>STM32F103xB</code> (you can find the actual config file as well if you want to take a look at it). I will provide this value by default in CMake, but any user of this library can provide another value; either on the command line when running cmake with <code>cmake -DSTM32_DEVICE_GROUP=XXX</code> or more properly when included from a parent CMakeLists.txt with <code>set(STM32_DEVICE_GROUP XXX CACHE STRING "Selected device group")</code>
</p>


<div class="org-src-container">
<pre class="src src-cmake">set(STM32_DEVICE_GROUP "STM32F103xB" CACHE STRING
 "Chip configuration as defined in stm32f1xx.h (default value for the bluepill)")

target_compile_definitions(ll PUBLIC ${STM32_DEVICE_GROUP})
target_compile_definitions(ll PUBLIC "USE_FULL_LL_DRIVER")
target_include_directories(ll PUBLIC CMSIS/Device/ST/STM32F1xx/Include)
</pre>
</div>

<p>
The very last step is to include the actual CMSIS itself which is simply in <code>CMSIS/Include</code> and to tell the compiler the target ARM architecture.
</p>

<div class="org-src-container">
<pre class="src src-cmake">target_include_directories(ll PUBLIC CMSIS/Include)
target_compile_options(ll PUBLIC
  -mthumb
  -mcpu=cortex-m3
  -mfloat-abi=soft
  -mlittle-endian)
</pre>
</div>

<p>
<b>Note:</b> The CMSIS folder is pretty huge.. It's over 60MB. Even stripped of most things it is over 10MB in size. However, <code>git</code> seems to compress it pretty easily
</p>

<p>
<b>Note:</b> This repository was made on <code>2018-08-18</code>. I make no promises about keeping it up to date with newer updates of the LL-API and CMSIS
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: George Kontsevich</p>
<p class="date">Created: 2019-03-02 六 11:18</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
